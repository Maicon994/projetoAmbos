<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Gerenciar Pagamentos</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
        }

        header {
            background-color: #ff7f27;
            color: white;
            padding: 12px;
            font-size: 24px;
        }

        #voltar {
            background: #cccccc;
            padding: 6px 10px;
            border-radius: 4px;
            color: #000;
            text-decoration: none;
            margin-right: 10px;
        }

        h1 {
            text-align: center;
            margin-top: 25px;
        }

        .container {
            display: flex;
            justify-content: center;
            margin-top: 25px;
        }

        .lista {
            width: 90%;
            max-width: 1000px;
            background-color: #e6e6e6;
            padding: 20px;
            border-radius: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th,
        td {
            border: 1px solid #aaa;
            padding: 8px;
            text-align: left;
        }

        th {
            background: #f0f0f0;
        }

        .botoes {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 25px;
        }

        .btn {
            padding: 10px 25px;
            border: none;
            cursor: pointer;
            color: white;
            font-size: 16px;
            border-radius: 5px;
        }

        .pagar {
            background-color: #007bff;
        }

        .excluir {
            background-color: #ff4444;
        }

        .pago-row {
            opacity: 0.6;
            text-decoration: line-through;
        }
    </style>
</head>

<body>

    <header>
        <a id="voltar" href="inicial.html">Voltar</a>
        Ambos
    </header>

    <h1>Gerenciar Pagamentos</h1>

    <div class="container">
        <div class="lista">
            <table id="tabelaPagamentos">
                <tr>
                    <th>Selecionar</th>
                    <th>Fornecedor</th>
                    <th>Valor Base</th>
                    <th>Data Compra</th>
                    <th>Data Vencimento</th>
                    <th>Dias Atraso</th>
                    <th>Juros (%/dia)</th>
                </tr>
            </table>
        </div>
    </div>

    <div class="botoes">
        <button class="btn pagar" onclick="irParaPagamento()">Pagar selecionado</button>
        <button class="btn excluir" onclick="excluirSelecionado()">Excluir seleção</button>
    </div>

    <script type="module">
        import { db } from "../scripts/firebase.js"
        import { collection, getDocs, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

        function diasAtrasoPara(dataVencimento) {
            const hoje = new Date();
            const venc = new Date(dataVencimento + 'T00:00:00');
            const msPorDia = 1000 * 60 * 60 * 24;
            const diff = Math.floor((hoje - venc) / msPorDia);
            return diff > 0 ? diff : 0;
        }

        function calcularValorFinal(valor, diasAtraso, jurosPercent) {
            if (!diasAtraso || diasAtraso <= 0) return Number(valor);
            const jurosDia = (jurosPercent === '' || jurosPercent === undefined || jurosPercent === null) ? 0.5 / 100 : Number(jurosPercent) / 100;
            return Math.round(Number(valor) * (1 + jurosDia * diasAtraso) * 100) / 100;
        }

        async function carregarPagamentos() {
            const dadosBanco = await getDocs(collection(db, "pagamentos"))
            const lista = []
            for (const doc of dadosBanco.docs) {
                lista.push({ id: doc.id, ...doc.data() })
            }

            const tabela = document.getElementById("tabelaPagamentos");
            tabela.querySelectorAll("tr.row-item")?.forEach(r => r.remove());

            lista.forEach((p, index) => {
                const dias = diasAtrasoPara(p.dataVencimento);

                tabela.insertAdjacentHTML('beforeend', `
            <tr class="row-item ${p.pago ? 'pago-row' : ''}">
                <td><input type="checkbox" class="check" data-index="${index}"></td>
                <td>${p.fornecedor}</td>
                <td>R$ ${Number(p.valor).toFixed(2)}</td>
                <td>${p.dataCompra}</td>
                <td>${p.dataVencimento}</td>
                <td>${dias}</td>
                <td>${Number(p.juros).toFixed(2)}%</td>
            </tr>
        `);
            });
        }

        function getSelecionados() {
            const checks = document.querySelectorAll(".check:checked");
            return [...checks].map(c => parseInt(c.dataset.index));
        }

        function irParaPagamento() {
            const selecionados = getSelecionados();
            if (selecionados.length !== 1) {
                alert("Selecione exatamente 1 pagamento para pagar.");
                return;
            }
            const idx = selecionados[0];
            window.location.href = `pagar.html?tipo=pagamento&index=${idx}`;
        }

        async function excluirSelecionado() {
            const selecionados = getSelecionados();
            if (selecionados.length === 0) { alert("Selecione ao menos 1 item."); return; }
            if (!confirm("Tem certeza que deseja excluir os itens selecionados?")) return;

            let id = selecionados.pop();

            try {
                const documentoDeletar = doc(db, "pagamentos", id)
                await deleteDoc(documentoDeletar)
                console.log("Conta com ID" + id + "foi excluída")
            } catch (error) {
                console.log("Erro ao excluir conta", error)
                alert("Erro ao excluir conta. Tente novamente mais tarde.")
                return false;
            }

            carregarPagamentos();
        }
        carregarPagamentos();
    </script>

</body>

</html>